pipeline {
    agent any
    
    stages {
        stage('Send Email') {
            steps {
                script {
                    def mailBody = """
                        Please review the changes and respond with 'APPROVED' or 'REJECTED'.
                    """
                    mail to: 'kthangaraju@yahoo.com',
                         subject: 'Code Review Request',
                         body: mailBody
                }
            }
        }
    }
    
    post {
        always {
            script {
                def responseReceived = false
                def timeoutReached = false
                def latestEmail = null
                
                def startTime = System.currentTimeMillis()
                def timeout = 30 * 10000 // 30 seconds
                
                try {
                    waitUntil {
                        def currentTime = System.currentTimeMillis()
                        
                        // Check if timeout has been reached
                        if (currentTime - startTime >= timeout) {
                            timeoutReached = true
                            return true // Stop waiting
                        }
                        
                        // Check for email response
                        latestEmail = emailext(
                            subject: "Re: Code Review Request", 
                            bodyContains: "APPROVED|REJECTED",
                            maxLines: 1
                        )
                        
                        if (latestEmail != null) {
                            responseReceived = true
                            return true // Stop waiting
                        }
                        
                        // Continue waiting
                        return false
                    }
                } catch (Exception e) {
                    // Exception occurred during waitUntil
                    echo "Error occurred: ${e.message}"
                }
                
                if (timeoutReached) {
                    echo "No response received within the specified time frame."
                } else if (responseReceived) {
                    // Process the email response
                    def response = latestEmail.getBody().contains("APPROVED") ? "Approved" : "Rejected"
                    echo "Received response: $response"
                    
                    // Take appropriate action based on response
                    if (response == "Approved") {
                        // Proceed with the next steps in your pipeline
                    } else {
                        // Take corrective action or halt the pipeline
                    }
                }
            }
        }
    }
}
