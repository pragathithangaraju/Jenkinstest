pipeline {
    agent any
    
    stages {
        stage('Send Email') {
            steps {
                script {
                    def mailBody = """
                        Please review the changes and respond with 'APPROVED' or 'REJECTED'.
                    """
                    emailext body: mailBody, 
                             subject: 'Code Review Request', 
                             to: 'kthangaraju@yahoo.com',
                             replyTo: 'jenkins@example.com'
                }
            }
        }
    }
    
    post {
        always {
            script {
                try {
                    timeout(time: 60, unit: 'SECONDS') {
                        // Parse email responses within a specific timeout
                        def response = emailext(
                            subject: "Code Review Request", 
                            bodyContains: "APPROVED|REJECTED",
                            maxLines: 1
                        )
                        
                        if (response != null) {
                            response = response.getBody().contains("APPROVED") ? "Approved" : "Rejected"
                            echo "Received response: $response"
                            
                            // Take appropriate action based on response
                            if (response == "Approved") {
                                // Proceed with the next steps in your pipeline
                            } else {
                                // Take corrective action or halt the pipeline
                            }
                        } else {
                            echo "No response received within the specified time frame."
                        }
                    }
                } catch (Exception e) {
                    echo "Timeout occurred while waiting for response."
                }
            }
        }
    }
}
