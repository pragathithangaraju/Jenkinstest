pipeline {
    agent any
    
    stages {
        stage('Send Email') {
            steps {
                script {
                    def mailBody = """
                        Please review the changes and respond with 'APPROVED' or 'REJECTED'.
                    """
                    emailext body: mailBody,
                             subject: 'Code Review Request',
                             to: 'kthangaraju@yahoo.com',
                             replyTo: 'raju.thanga@gmail.com'
                }
            }
        }
        
        stage('Process Response') {
            steps {
                script {
                    def responseReceived = false
                    def timeoutReached = false
                    def response = null
                    
                    def startTime = System.currentTimeMillis()
                    def timeout = 30 * 5000 // 30 seconds
                    
                    while (!responseReceived && !timeoutReached) {
                        // Fetch the latest build
                        def build = currentBuild.rawBuild
                        def console = build.getLog(1000).join('\n')
                        
                        // Check if the console log contains the response
                        if (console.contains("APPROVED")) {
                            echo "Response received: Approved. Proceeding with next steps."
                            // Proceed with the next steps in your pipeline
                            responseReceived = true
                        } else if (console.contains("REJECTED")) {
                            echo "Response received: Rejected. Halting the pipeline."
                            // Take corrective action or halt the pipeline
                            error "Code review rejected. Halting the pipeline."
                        }
                        
                        // Check if timeout has been reached
                        if (System.currentTimeMillis() - startTime >= timeout) {
                            timeoutReached = true
                        }
                        
                        // Sleep for a short interval before checking again
                        sleep 1000 // 1 second
                    }
                    
                    if (timeoutReached) {
                        echo "No response received within the specified time frame."
                        // Handle the case where no response is received within the specified timeout
                    }
                }
            }
        }
    }
}
